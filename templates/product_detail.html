{% extends "base.html" %}

{% block title %}{{ product.name }} - SnapCart{% endblock %}

{% block content %}
<style>
    /* Button Styling Fixes for this page */
    .btn--buy {
        background-color: #000000 !important; /* Black Color */
        color: white !important;
        border: 1px solid #000000;
        width: 100%;           /* Full Width */
        display: block;
        padding: 14px 0;
        border-radius: 5px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .btn--buy:hover {
        background-color: #333333 !important; /* Dark Grey on Hover */
        transform: translateY(-2px);
    }

    /* Container to stack buttons vertically */
    .button-stack {
        display: flex;
        flex-direction: column;
        gap: 15px; /* Gap between buttons */
        width: 100%;
        margin-top: 20px;
    }
</style>

<section class="product-detail-page">
  <div class="container">
    <a href="{{ url_for('products') }}" class="back-link">← Back to products</a>

    <div class="product-detail-grid">

      <div class="product-image-large">
        <img src="{{ product.image_url }}" alt="{{ product.name }}">
      </div>

      <div class="product-detail-info">

        <h1 class="product-title">{{ product.name }}</h1>

        <div class="product-meta">
          <div class="meta-item">Category: {{ product.category_name }}</div>
          <div class="meta-item">Price: ₹{{ "%.2f"|format(product.price) }}</div>
        </div>

        <p class="product-description-full">
          {{ product.description }}
        </p>

        <div class="detail-stock-row">
          {% if product.stock > 0 %}
          <span class="status status--success pill">In Stock ({{ product.stock }})</span>
          {% else %}
          <span class="status status--error pill">Out of Stock</span>
          {% endif %}
        </div>

        <div class="detail-buttons button-stack">

          <button class="btn--buy" onclick="buyNow('{{ product.id }}')">
            Buy Now
          </button>

          {% if is_logged_in and product.stock > 0 %}
          <button class="btn--buy add-to-cart-btn" data-product-id="{{ product.id }}">
            Add to Cart
          </button>
          {% endif %}

        </div>

      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/cart.js') }}"></script>

<script>
  function buyNow(productId) {
    console.log("Buy Now clicked for Product ID:", productId);

    fetch('/api/cart/add', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        product_id: productId,
        quantity: 1
      })
    })
      .then(response => {
        if (response.status === 401) {
          window.location.href = "{{ url_for('login') }}";
          return null;
        }
        return response.json();
      })
      .then(data => {
        if (!data) return;

        if (data.success || data.message === 'Added to cart') {
          // Redirect to checkout immediately
          window.location.href = "{{ url_for('checkout') }}";
        } else {
          alert('Error: ' + (data.error || 'Could not add to cart'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Something went wrong. Check console for details.');
      });
  }
</script>
{% endblock %}